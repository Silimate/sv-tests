#!/usr/bin/env python3
"""
Generator script for VlogHammer tests.
This script invokes the vloghammer generation process (make gen_samples)
and wraps the resulting Verilog files for sv-tests.
"""

import os
import sys
import subprocess
import glob

# Template for the sv-tests wrapper file
WRAPPER_TEMPLATE = """/*
:name: {name}
:description: VlogHammer generated test: {basename}
:tags: vloghammer
:type: simulation elaboration parsing
:files: {files}
:top_module: top
*/
module top;
    // Test bench code can go here
endmodule
"""

def main():
    # Required environment variables
    try:
        third_party_dir = os.environ['THIRD_PARTY_DIR']
        tests_dir = os.environ['TESTS_DIR']
    except KeyError:
        print("Error: TESTS_DIR and THIRD_PARTY_DIR environment variables must be set")
        sys.exit(1)

    # Path to vloghammer submodule
    vloghammer_dir = os.path.join(third_party_dir, 'test', 'vloghammer')
    if not os.path.isdir(vloghammer_dir):
        print(f"Error: VlogHammer directory not found at {vloghammer_dir}")
        sys.exit(1)

    # Output directory for generated tests
    output_dir = os.path.join(tests_dir, 'generated', 'vloghammer')
    os.makedirs(output_dir, exist_ok=True)

    print(f"Generating VlogHammer samples in {vloghammer_dir}")
    
    # 1. trigger vloghammer generation
    # We use 'gen_samples' for a smaller set, or 'generate' for full set.
    # Using 'gen_samples' to keep it fast for now as per plan.
    try:
        subprocess.check_call(['make', 'gen_samples'], cwd=vloghammer_dir)
    except subprocess.CalledProcessError as e:
        print(f"Error running make gen_samples: {e}")
        sys.exit(1)

    # 2. Find generated RTL files
    rtl_dir = os.path.join(vloghammer_dir, 'rtl')
    verilog_files = glob.glob(os.path.join(rtl_dir, '*.v'))
    
    print(f"Found {len(verilog_files)} generated files.")

    # 3. Create wrappers
    for v_file in verilog_files:
        basename = os.path.basename(v_file)
        test_name = "vloghammer_" + os.path.splitext(basename)[0]
        
        # Absolute path to the original file
        abs_v_file = os.path.abspath(v_file)
        
        # Determine wrapper filename
        wrapper_filename = os.path.join(output_dir, test_name + '.sv')
        
        with open(wrapper_filename, 'w') as f:
            f.write(WRAPPER_TEMPLATE.format(
                name=test_name,
                basename=basename,
                files=abs_v_file
            ))

    print(f"Successfully generated {len(verilog_files)} wrappers in {output_dir}")

if __name__ == "__main__":
    main()
