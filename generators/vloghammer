#!/usr/bin/env python3
# -*- coding: utf-8 -*-
#
# Copyright (C) 2019 The SymbiFlow Authors.
#
# Use of this source code is governed by a ISC-style
# license that can be found in the LICENSE file or at
# https://opensource.org/licenses/ISC
#
# SPDX-License-Identifier: ISC

import os
import sys
import re

WRAPPER_TEMPLATE = """
module {name} (
{signals}
);
{module_name} {basename} (
{connections}
);
{dut_content}
endmodule
"""


def parse_verilog_ports(content):
    """
    Parses a Verilog file content to find module name and ports.
    """
    module_pattern = re.compile(r'^\s*module\s+(\w+)', re.MULTILINE)
    module_match = module_pattern.search(content)

    if not module_match:
        return None, []

    module_name = module_match.group(1)

    port_pattern = re.compile(
        r'^\s*(input|output)\s+(?:(\[.*?\])\s+)?(\w+);', re.MULTILINE)

    ports = []
    for match in port_pattern.finditer(content):
        direction = match.group(1)
        width = match.group(2) if match.group(2) else ""
        name = match.group(3)
        ports.append({'dir': direction, 'width': width, 'name': name})

    return module_name, ports


def main():
    try:
        third_party_dir = os.environ['THIRD_PARTY_DIR']
        tests_dir = os.environ['TESTS_DIR']
    except KeyError:
        print(
            "Error: TESTS_DIR and THIRD_PARTY_DIR environment variables must be set"
        )
        sys.exit(1)

    vloghammer_dir = os.path.join(third_party_dir, 'tests', 'vloghammer')
    # Some setups might have 'test' instead of 'tests'
    if not os.path.isdir(vloghammer_dir):
        vloghammer_dir = os.path.join(third_party_dir, 'test', 'vloghammer')

    if not os.path.isdir(vloghammer_dir):
        print(
            f"Error: VlogHammer directory not found in third_party/tests/ or third_party/test/"
        )
        sys.exit(1)

    output_dir = os.path.join(tests_dir, 'generated', 'vloghammer')
    os.makedirs(output_dir, exist_ok=True)

    verilog_files = []
    for root, dirs, files in os.walk(os.path.join(vloghammer_dir, 'rtl')):
        for file in files:
            if file.endswith('.v'):
                verilog_files.append(os.path.join(root, file))

    for verilog_file in verilog_files:
        basename = os.path.splitext(os.path.basename(verilog_file))[0]
        test_name = basename

        with open(verilog_file, 'r') as f:
            content = f.read()

        module_name, ports = parse_verilog_ports(content)

        if not module_name:
            print(f"Warning: Could not parse module in {verilog_file}")
            continue

        signals = []
        connections = []

        for port in ports:
            width_str = f" {port['width']}" if port['width'] else ""
            signals.append(f"    {port['dir']}{width_str} {port['name']}")
            connections.append(f"    .{port['name']}({port['name']})")

        signals_str = ",\n".join(signals)
        connections_str = ",\n".join(connections)

        wrapper_filename = os.path.join(output_dir, test_name + '.v')

        with open(wrapper_filename, 'w') as f:
            f.write(
                WRAPPER_TEMPLATE.format(
                    name=test_name,
                    basename=basename,
                    signals=signals_str,
                    module_name=module_name,
                    connections=connections_str,
                    dut_content=content))

    print(
        f"Successfully generated {len(verilog_files)} wrappers in {output_dir}"
    )


if __name__ == "__main__":
    main()
